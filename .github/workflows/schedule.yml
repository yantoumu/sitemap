name: Sitemap Keyword Analysis

on:
  # æ¯4å°æ—¶è‡ªåŠ¨æ‰§è¡Œ
  schedule:
    - cron: '0 */6 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      log_level:
        description: 'æ—¥å¿—çº§åˆ«'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼ï¼ˆä¸æäº¤æ•°æ®ï¼‰'
        required: false
        default: false
        type: boolean
      health_check_only:
        description: 'ä»…æ‰§è¡Œå¥åº·æ£€æŸ¥'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.9'
  
jobs:
  sitemap-analysis:
    runs-on: ubuntu-latest

    # é…ç½®å¿…è¦çš„æƒé™ä»¥æ”¯æŒè‡ªåŠ¨Gitæäº¤
    permissions:
      contents: write  # å…è®¸æ¨é€ä»£ç åˆ°ä»“åº“
      actions: read    # å…è®¸è¯»å–ActionsçŠ¶æ€

    env:
      SEO_API_URLS: ${{ secrets.SEO_API_URLS }}
      BACKEND_API_URL: ${{ secrets.BACKEND_API_URL }}
      BACKEND_API_TOKEN: ${{ secrets.BACKEND_API_TOKEN }}
      SITEMAP_URLS: ${{ secrets.SITEMAP_URLS }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨GitHub Tokenè¿›è¡Œè®¤è¯
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p data logs
        
    - name: éªŒè¯é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡
      run: |
        echo "ğŸ” éªŒè¯å¿…éœ€çš„é…ç½®æ–‡ä»¶..."

        # éªŒè¯å¿…éœ€çš„é…ç½®æ–‡ä»¶
        if [ ! -f "config/config.yaml" ]; then
          echo "âŒ é”™è¯¯: config/config.yaml ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… config/config.yaml å­˜åœ¨"

        # æ£€æŸ¥URLè§„åˆ™æ–‡ä»¶ï¼ˆæ”¯æŒå¤šä¸ªå¯èƒ½çš„æ–‡ä»¶åï¼‰
        if [ -f "config/game_url_rules.yaml" ]; then
          echo "âœ… config/game_url_rules.yaml å­˜åœ¨"
        elif [ -f "config/url_rules.yaml" ]; then
          echo "âœ… config/url_rules.yaml å­˜åœ¨"
        else
          echo "âŒ é”™è¯¯: URLè§„åˆ™æ–‡ä»¶ä¸å­˜åœ¨ (éœ€è¦ config/game_url_rules.yaml æˆ– config/url_rules.yaml)"
          exit 1
        fi

        echo "ğŸ” éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡..."

        # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
        for var_name in SEO_API_URLS BACKEND_API_URL BACKEND_API_TOKEN SITEMAP_URLS ENCRYPTION_KEY; do
          var_value=$(eval echo \$$var_name)
          if [ -z "$var_value" ]; then
            echo "âŒ é”™è¯¯: $var_name ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            exit 1
          fi
          echo "âœ… $var_name å·²è®¾ç½®"
        done

        echo "ğŸ” éªŒè¯sitemapé…ç½®..."

        # æ£€æŸ¥sitemapé…ç½®ï¼šä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå¤‡é€‰æ–‡ä»¶
        if [ -n "$SITEMAP_URLS" ]; then
          echo "âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ SITEMAP_URLS é…ç½®sitemapåˆ—è¡¨"
        elif [ -f "config/sitemaps.txt" ]; then
          echo "âœ… ä½¿ç”¨æ–‡ä»¶ config/sitemaps.txt é…ç½®sitemapåˆ—è¡¨"
        else
          echo "âŒ é”™è¯¯: æ—¢æ²¡æœ‰è®¾ç½® SITEMAP_URLS ç¯å¢ƒå˜é‡ï¼Œä¹Ÿæ²¡æœ‰ config/sitemaps.txt æ–‡ä»¶"
          exit 1
        fi

        echo "ğŸ‰ é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"
        
    # ç¯å¢ƒå˜é‡å·²åœ¨jobçº§åˆ«è®¾ç½®ï¼Œæ— éœ€é‡å¤è®¾ç½®
        
    # ç¯å¢ƒå˜é‡éªŒè¯å·²åœ¨"éªŒè¯é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡"æ­¥éª¤ä¸­å®Œæˆ
        
    - name: æ‰§è¡Œå¥åº·æ£€æŸ¥
      run: |
        echo "æ‰§è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥..."
        python main.py --health-check --log-level $LOG_LEVEL

    - name: æ‰§è¡Œsitemapåˆ†æ
      if: ${{ github.event.inputs.health_check_only != 'true' }}
      run: |
        echo "å¼€å§‹æ‰§è¡Œsitemapå…³é”®è¯åˆ†æ..."

        # æ„å»ºå‘½ä»¤å‚æ•°ï¼ˆä¸æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯ï¼‰
        CMD_ARGS="--log-level $LOG_LEVEL"

        # æ·»åŠ è¯•è¿è¡Œå‚æ•°
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          CMD_ARGS="$CMD_ARGS --dry-run"
          echo "âœ… è¯•è¿è¡Œæ¨¡å¼å·²å¯ç”¨"
        fi

        echo "âœ… å¼€å§‹æ‰§è¡Œåˆ†æï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ï¼‰"
        # æ‰§è¡Œåˆ†æï¼ˆç¯å¢ƒå˜é‡ä¼šè‡ªåŠ¨ä¼ é€’ç»™åº”ç”¨ç¨‹åºï¼‰
        python main.py $CMD_ARGS
        
    - name: æ£€æŸ¥æ‰§è¡Œç»“æœ
      if: ${{ github.event.inputs.health_check_only != 'true' }}
      run: |
        echo "æ£€æŸ¥æ‰§è¡Œç»“æœ..."

        # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼ˆä»…æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºå†…å®¹ï¼‰
        if [ -f "logs/sitemap_analyzer.log" ]; then
          echo "æ—¥å¿—æ–‡ä»¶å¤§å°: $(du -h logs/sitemap_analyzer.log | cut -f1)"
          echo "æ—¥å¿—è¡Œæ•°: $(wc -l < logs/sitemap_analyzer.log)"
          echo "âš ï¸ æ—¥å¿—å†…å®¹åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸åœ¨æ­¤æ˜¾ç¤º"
        else
          echo "è­¦å‘Š: æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
        fi

        # æ£€æŸ¥æ•°æ®æ–‡ä»¶ï¼ˆä»…æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºå†…å®¹ï¼‰
        if [ -f "data/processed_urls.json" ]; then
          echo "æ•°æ®æ–‡ä»¶å¤§å°: $(du -h data/processed_urls.json | cut -f1)"
          echo "âš ï¸ æ•°æ®æ–‡ä»¶åŒ…å«åŠ å¯†URLï¼Œä¸æ˜¾ç¤ºå…·ä½“å†…å®¹"
        else
          echo "ä¿¡æ¯: æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆå¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œæˆ–æ— æ–°æ•°æ®ï¼‰"
        fi

    - name: æäº¤å¤„ç†ç»“æœåˆ°GitHub
      if: ${{ github.event.inputs.health_check_only != 'true' && github.event.inputs.dry_run != 'true' }}
      run: |
        echo "æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®éœ€è¦æäº¤..."

        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯å’Œè®¤è¯
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # é…ç½®Gitä½¿ç”¨GITHUB_TOKENè¿›è¡Œè®¤è¯
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

        # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®æ–‡ä»¶å˜æ›´
        if [ -f "data/processed_urls.json" ]; then
          # æ·»åŠ æ•°æ®æ–‡ä»¶åˆ°Git
          git add data/processed_urls.json

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ–°æ•°æ®éœ€è¦æäº¤"
          else
            # è·å–æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
            FILE_SIZE=$(du -h data/processed_urls.json | cut -f1)

            # æäº¤æ•°æ®æ–‡ä»¶
            COMMIT_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            git commit -m "data: æ›´æ–°å¤„ç†ç»“æœæ•°æ® ($FILE_SIZE) - $COMMIT_TIME [skip ci]"

            # æ¨é€åˆ°GitHub
            git push origin main

            echo "âœ… æ•°æ®å·²æˆåŠŸæäº¤åˆ°GitHubä»“åº“"
            echo "ğŸ“Š æ•°æ®æ–‡ä»¶å¤§å°: $FILE_SIZE"
          fi
        else
          echo "ğŸ“ æ²¡æœ‰æ•°æ®æ–‡ä»¶ç”Ÿæˆï¼Œè·³è¿‡æäº¤"
        fi
        
    - name: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
      if: always()
      run: |
        echo "ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š..."
        
        REPORT_FILE="execution-report-$(date +%Y%m%d-%H%M%S).md"
        
        cat > $REPORT_FILE << EOF
        # Sitemapå…³é”®è¯åˆ†ææ‰§è¡ŒæŠ¥å‘Š
        
        ## æ‰§è¡Œä¿¡æ¯
        - **æ‰§è¡Œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
        - **è¿è¡ŒID**: ${{ github.run_id }}
        - **æäº¤SHA**: ${{ github.sha }}
        - **æ—¥å¿—çº§åˆ«**: $LOG_LEVEL
        - **è¯•è¿è¡Œæ¨¡å¼**: ${{ github.event.inputs.dry_run || 'false' }}
        - **ä»…å¥åº·æ£€æŸ¥**: ${{ github.event.inputs.health_check_only || 'false' }}

        ## æ–‡ä»¶çŠ¶æ€
        EOF
        
        # æ·»åŠ æ–‡ä»¶ä¿¡æ¯
        if [ -f "logs/sitemap_analyzer.log" ]; then
          echo "- **æ—¥å¿—æ–‡ä»¶**: å­˜åœ¨ ($(du -h logs/sitemap_analyzer.log | cut -f1))" >> $REPORT_FILE
        else
          echo "- **æ—¥å¿—æ–‡ä»¶**: ä¸å­˜åœ¨" >> $REPORT_FILE
        fi
        
        if [ -f "data/processed_urls.json" ]; then
          echo "- **æ•°æ®æ–‡ä»¶**: å­˜åœ¨ ($(du -h data/processed_urls.json | cut -f1))" >> $REPORT_FILE
        else
          echo "- **æ•°æ®æ–‡ä»¶**: ä¸å­˜åœ¨" >> $REPORT_FILE
        fi

        # æ·»åŠ æ•°æ®æäº¤çŠ¶æ€
        echo "" >> $REPORT_FILE
        echo "## æ•°æ®æŒä¹…åŒ–" >> $REPORT_FILE
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "- **æ•°æ®æäº¤**: è·³è¿‡ï¼ˆè¯•è¿è¡Œæ¨¡å¼ï¼‰" >> $REPORT_FILE
        elif [ "${{ github.event.inputs.health_check_only }}" = "true" ]; then
          echo "- **æ•°æ®æäº¤**: è·³è¿‡ï¼ˆä»…å¥åº·æ£€æŸ¥ï¼‰" >> $REPORT_FILE
        else
          echo "- **æ•°æ®æäº¤**: å·²æ‰§è¡Œï¼ˆåŠ å¯†URLæ•°æ®å·²ä¿å­˜åˆ°GitHubä»“åº“ï¼‰" >> $REPORT_FILE
        fi

        echo "æ‰§è¡ŒæŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"

    # æ³¨æ„:
    # - æ•°æ®æ–‡ä»¶(data/processed_urls.json)å·²é€šè¿‡Gitæäº¤åˆ°ä»“åº“ï¼ˆåŒ…å«åŠ å¯†URLï¼‰
    # - æ—¥å¿—æ–‡ä»¶ä¸ä¸Šä¼ ï¼Œå› ä¸ºåŒ…å«æ•æ„Ÿçš„APIä¿¡æ¯
    # - å¦‚éœ€è°ƒè¯•ï¼Œè¯·æ£€æŸ¥GitHubä»“åº“ä¸­çš„æ•°æ®æ–‡ä»¶æˆ–ä½¿ç”¨æœ¬åœ°ç¯å¢ƒ
        
    - name: ä¸Šä¼ æ‰§è¡ŒæŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: reports-${{ github.run_number }}
        path: execution-report-*.md
        retention-days: 30
        if-no-files-found: ignore
        
    # æ³¨æ„: ä¸ä¸Šä¼ é”™è¯¯æ—¥å¿—ï¼Œå› ä¸ºå¯èƒ½åŒ…å«æ•æ„Ÿçš„APIä¿¡æ¯
    # å¦‚éœ€è°ƒè¯•å¤±è´¥åŸå› ï¼Œè¯·æ£€æŸ¥GitHub Actionsçš„å·¥ä½œæµæ—¥å¿—
    # æˆ–åœ¨æœ¬åœ°ç¯å¢ƒä¸­é‡ç°é—®é¢˜è¿›è¡Œè°ƒè¯•
        
    - name: é€šçŸ¥æ‰§è¡Œç»“æœ
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Sitemapå…³é”®è¯åˆ†ææ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ Sitemapå…³é”®è¯åˆ†ææ‰§è¡Œå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
        
        echo "æ‰§è¡Œæ‘˜è¦:"
        echo "- è¿è¡ŒID: ${{ github.run_id }}"
        echo "- æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "- çŠ¶æ€: ${{ job.status }}"
